services:
  sd-webui-server-sd15:
    image: sd-webui-deployment:latest
    command: /bin/bash -c "./launch.sh"
    tty: true
    volumes:
      - /mnt/data/docker/sd-webui-hf-home:/hf-home
      - /mnt/data/docker/sd-webui-models:/stable-diffusion-webui/models
      - /mnt/data/docker/sd-webui-controlnet-models:/stable-diffusion-webui/extensions/sd-webui-controlnet/models
      - /mnt/data/docker/sd-webui-codeformer-models:/stable-diffusion-webui/repositories/CodeFormer/weights
    environment:
      SD_VERSION: "SD15"
    network_mode: "host"

  sd-webui-worker-sd15:
    image: sd-webui-deployment:latest
    command: /bin/bash -c "conda run --no-capture-output -n worker python3 worker.py --worker sd_webui_worker_sd15"
    environment:
      RABBIT_URL: "amqp://guest:guest@localhost:5672?heartbeat=3600"
      EXCHANGE_NAME: "pencil_exchange"
      WORKER_NAME: "sd-webui-worker-sd15"
      SD_WEBUI_WORKER_QUEUE: "sd_webui_worker_queue"
      SD_WEBUI_WORKER_ROUTING_KEY: "*.submit.sd15"
      SD_WEBUI_CALLBACK_ROUTING_KEY: "*.callback.sd15"
    network_mode: "host"
